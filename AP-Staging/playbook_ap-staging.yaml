---
- name: Configure using Google Sheet
  hosts: C9800
  vars_prompt:
    - name: sheetid_input
      prompt: "Enter the Google Sheet ID (leave empty to skip)"
      private: no

  vars:
    apmacs: []
    maclist: []

  tasks:
    - ios_command:
        commands:
          - show version | i uptime
      register: show

    - debug:
        var: show.stdout_lines

    - name: Download JSON content play
      uri:
        url: "http://gsx2json.com/api?id={{ sheetid_input }}&columns=false"
        return_content: yes
      register: jsoncontent

    - name: Define List
      debug:
        msg: "{{ jsoncontent.json | json_query(jmesquery) }}"
      vars:
        jmesquery: "[*].{number: number, name: name, fqdn: fqdn, mac: mac, ip: ip, host: host, subnet: subnet, mask: mask, gateway: gateway, skip: skip, parsedfordnslookup: parsedfordnslookup, parsedforcontroller: parsedforcontroller, defaultname: defaultname, primary: primary, primaryip: primaryip, secondary: secondary, secondaryip: secondaryip, ptag: ptag, rtag: rtag, stag: stag}"

    - name: Apply names based on Mac
      ignore_errors: True
      ios_command:
        commands:
          - "ap name {{ item.defaultname }} name {{ item.name }}"
      loop: "{{ jsoncontent.json.rows }}"
      when:
        - item.skip == 0
